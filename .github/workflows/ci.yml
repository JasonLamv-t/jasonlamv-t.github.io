name: ci
on:
  push:
    branches:
      # - master
      - ci/cd

env:
  IMG_REPO: registry.cn-shenzhen.aliyuncs.com/image-vt
  IMG_NAME: cc-my-next-blog
  IMG_TAG: ${{ github.sha }}

jobs:
  build:
    name: Build Image and Push to ACR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup NodeJS
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install Dependencies
        run: yarn install

      - name: Lint
        run: yarn lint

      - name: Login to ACR
        uses: aliyun/acr-login@v1
        with:
          login-server: https://registry.cn-shenzhen.aliyuncs.com
          region-id: cn-shenzhen
          username: '${{ secrets.ACR_USERNAME }}'
          password: '${{ secrets.ACR_PASSWORD }}'

      - name: Build and push image
        run: |
          docker build -t $IMG_REPO/$IMG_NAME:$IMG_TAG .
          docker push $IMG_REPO/$IMG_NAME:$IMG_TAG
  deploy:
    name: Deploy Image to Tencent ECS
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Login to Tencent ECS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ECS_HOSTNAME }}
          username: ubuntu
          key: '${{ secrets.ECS_PRIVATE_KEY }}'
          envs: IMG_REPO, IMG_NAME, IMG_TAG
          script: docker rm -f $IMG_NAME &&
            docker run -d --restart=always -p 3000:3000 --name $IMG_NAME $IMG_REPO/$IMG_NAME:$IMG_TAG
